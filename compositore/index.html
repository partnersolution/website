	<!DOCTYPE html>
	<html lang="it">
	<head>
		<meta charset="UTF-8">
		<title>Itinerario Turistico ‚Äì Full Version</title>

		<!-- Leaflet (mappe) -->
		<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

		<!-- SortableJS (drag & drop cross-list) -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

		<!-- CSS verr√† inserito nel blocco 2 -->
		<style>
			/* ============================================================
		   GLOBAL STYLE
		   ============================================================ */
		body {
			margin: 0;
			display: flex;
			height: 100vh;
			background: #f4f4f4;
			overflow: hidden;
			font-family: Nunito, sans-serif;
		}


		/* ============================================================
		   SIDEBAR (catalogo servizi)
		   ============================================================ */
		#sidebarWrapper {
			display: flex;
			flex-direction: column;
			width: 360px;
			min-width: 360px;
			max-width: 360px;
			background: white;
			border-right: 1px solid #ccc;
		}

		#sidebar {
			flex: 1;
			padding: 20px;
			overflow-y: auto;
		}

		.filter-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.toggle-btn {
			background: #0077ff;
			color: white;
			border: none;
			padding: 6px 10px;
			border-radius: 4px;
			cursor: pointer;
		}

		/* Collassa l‚Äôintera sezione filtri */
		#filtersArea.collapsed {
			display: none;
		}

		label {
			font-weight: 600;
			margin-top: 10px;
			display: block;
		}

		select,
		input {
			width: 100%;
			padding: 8px;
			margin-top: 6px;
			border-radius: 6px;
			border: 1px solid #ccc;
		}

		/* Righe con checkbox */
		.checkbox-row {
			margin-top: 10px;
			display: flex;
			align-items: center;
			gap: 5px;
		}

		/* Rende invisibili i due filtri disabilitati */
		#showPurchased,
		label[for="showPurchased"],
		#showInserted,
		label[for="showInserted"] {
			display: none !important;
		}


		/* ============================================================
		   RISULTATI DEL CATALOGO
		   ============================================================ */
		.result-card {
			position: relative;
			background: #fff;
			padding: 8px;
			margin-bottom: 12px;
			border-radius: 6px;
			cursor: grab;
			display: flex;
			gap: 10px;
			box-shadow: 0 1px 3px rgba(0,0,0,0.15);
		}

		/* Ribbon (usato per "‚úî Inserito") */
		.ribbon {
			position: absolute;
			top: -6px;
			right: -6px;
			padding: 4px 8px;
			font-size: 14px;
			font-weight: bold;
			border-radius: 6px;
			background: #ff7a00;
			color: white;
			transform: rotate(10deg);
		}

		.icon {
			width: 28px;
			height: 28px;
		}


		/* ============================================================
		   ITINERARY AREA
		   ============================================================ */
		#itineraryContainer {
			flex: 1;
			display: flex;
			flex-direction: column;
			overflow: hidden;
		}

		#itinerary {
			flex: 1;
			padding: 20px;
			overflow-y: auto;
		}

		.day-box {
			background: #fff;
			padding: 12px;
			border-radius: 6px;
			margin-bottom: 15px;
			box-shadow: 0 1px 4px rgba(0,0,0,0.1);
		}

		.drop-area {
			min-height: 60px;
			border: 2px dashed #ccc;
			padding: 6px;
			border-radius: 6px;
			background: #fafafa;
			touch-action: none;
		}

		.day-item {
			background: #fff;
			border: 1px solid #ccc;
			padding: 6px;
			border-radius: 4px;
			margin-bottom: 6px;
		}

		.day-item input,
		.day-item textarea {
			width: 100%;
			padding: 4px;
			margin-bottom: 4px;
			border-radius: 4px;
			border: 1px solid #ccc;
		}

		/* Pulsante rimozione da un giorno dell‚Äôitinerario */
		.day-item button {
			background: #e74c3c;
			color: white;
			border: none;
			padding: 4px 6px;
			border-radius: 4px;
			cursor: pointer;
			margin-top: 4px;
		}


		/* ============================================================
		   MODALI GENERALI (Preview, Mappa catalogo, Mappa itinerario)
		   ============================================================ */
		#mapModal,
		#itineraryMapModal,
		#previewModal {
			position: fixed;
			inset: 0;
			display: none;               /* Nascoste finch√© non servono */
			justify-content: center;
			align-items: center;
			padding: 20px;
			z-index: 9999;
			background: rgba(0,0,0,0.55); /* Overlay */
		}

		/* Contenitore principale dei modali */
		.mapModalContent {
			background: white;
			width: 80%;
			height: 80%;
			border-radius: 10px;
			display: flex;
			flex-direction: column;
			overflow: hidden;
		}

		/* Card nella colonna risultati mappa */
		.modal-card {
			background: #fff;
			padding: 10px;
			margin-bottom: 10px;
			border-radius: 6px;
			border: 1px solid #ccc;
			position: relative;
		}


		/* ============================================================
		   RESPONSIVE / UTILITY (eventualmente espandibili)
		   ============================================================ */
		@media (max-width: 900px) {
			/* Sidebar pi√π stretta su tablet */
			#sidebarWrapper {
				width: 300px;
				min-width: 300px;
			}
		}
		
		.day-title-input {
			font-size: 18px;
			font-weight: 700;
			border: none;
			background: transparent;
			width: 90%;
			margin-bottom: 6px;
		}
		.day-title-input:focus {
			outline: 2px solid #0077ff;
			border-radius: 4px;
			background: #eef6ff;
		}

		.time-block {
			margin-top: 8px;
			padding: 6px;
			background: #f7f7f7;
			border: 1px solid #ddd;
			border-radius: 4px;
		}

		.time-block label {
			display:block;
			font-weight:600;
			margin-top:6px;
		}

		.time-inline {
			display: flex;
			align-items: center;
			justify-content: flex-end;
			gap: 8px;
			margin-top: 6px;
			font-size: 13px;
			opacity: 0.9;
		}

		.time-inline input {
			padding: 3px;
			border: 1px solid #ccc;
			border-radius: 4px;
		}

		.img-btn {
			background: #3498db;
			color: white;
			border: none;
			padding: 5px 10px;
			border-radius: 6px;
			cursor: pointer;
			margin-top: 6px;
		}

		.img-gallery {
			display: flex;
			flex-wrap: wrap;
			gap: 6px;
			margin-top: 6px;
		}

		.detail-img {
			width: 80px;
			height: 80px;
			object-fit: cover;
			border-radius: 6px;
			border: 1px solid #ccc;
		}

		</style>
	</head>

	<body>

	<!-- ============================================================
		 SVG ICONS (risorse usate nel catalogo e nelle liste)
		 ============================================================ -->
	<svg style="display:none;">
		<symbol id="icon-place" viewBox="0 0 24 24">
			<path fill="#007BFF" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
		</symbol>

		<symbol id="icon-hotel" viewBox="0 0 24 24">
			<path fill="#8E44AD" d="M7 14h10V5h2v14h-2v-2H7v2H5V5h2z"/>
		</symbol>

		<symbol id="icon-activity" viewBox="0 0 24 24">
			<path fill="#27AE60" d="M20 12H4v3h16z"/>
		</symbol>

		<symbol id="icon-transport" viewBox="0 0 24 24">
			<path fill="#E67E22" d="M21 16l-8-5V3l-3 0v8l-8 5v2l8-2v6l-2 1v1l3-1 3 1v-1l-2-1v-6l8 2z"/>
		</symbol>
	</svg>



	<!-- ============================================================
		 SIDEBAR SINISTRA (Catalogo servizi)
		 ============================================================ -->
	<div id="sidebarWrapper">

		<div id="sidebar">

			<!-- Header con pulsante per collassare i filtri -->
			<div class="filter-header">
				<h2>üìö Seleziona dal catalogo</h2>
				<button id="toggleFiltersBtn" class="toggle-btn">‚¨ÜÔ∏è</button>
			</div>

			<!-- Sezione filtri catalogo -->
			<div id="filtersArea">

				<label>Tipologia</label>
				<select id="typeSelector">
					<option value="all">Tutti</option>
					<option value="places">Luoghi</option>
					<option value="structures">Strutture</option>
					<option value="activities">Attivit√†</option>
					<option value="transport">Trasporti</option>
				</select>

				<label>Titolo</label>
				<input type="text" id="searchInput">

				<label>Destinazione</label>
				<input type="text" id="destinationInput">

				<label>Fornitore</label>
				<input type="text" id="supplierInput">

				<!-- Filtri rimossi: restano nascosti -->
				<div class="checkbox-row">
					<input type="checkbox" id="showPurchased">
					<label for="showPurchased">Solo servizi gi√† in preventivo</label>
				</div>

				<div class="checkbox-row">
					<input type="checkbox" id="showInserted">
					<label for="showInserted">Mostra gi√† inseriti</label>
				</div>

				<!-- Pulsanti ricerca -->
				<button id="searchBtn"
					style="width:100%; padding:10px; background:#222; color:white; border:none; border-radius:6px; margin-top:15px;">
					üîé Cerca
				</button>

				<button id="mapSearchBtn"
					style="width:100%; padding:10px; margin-top:10px; background:#0077ff; color:white; border:none; border-radius:6px;">
					üó∫Ô∏è Cerca sulla mappa
				</button>
			</div>

			<h3>Risultati</h3>
			<div id="results"></div>
		</div>
	</div>



	<!-- ============================================================
		 AREA ITINERARIO (parte destra della UI)
		 ============================================================ -->
	<div id="itineraryContainer">

		<!-- Configurazione generale itinerario -->
		<div style="display:flex; gap:10px; padding:15px; background:#fff; border-bottom:1px solid #ddd;">

			<div>
				<label style="font-weight:600;">Data inizio</label>
				<input type="date" id="startDate" style="padding:5px; border-radius:6px; border:1px solid #ccc;">
			</div>

			<div>
				<label style="font-weight:600;">Giorni</label>
				<input type="number" id="numDays" value="10" min="1" max="14"
					style="padding:5px; width:80px; border-radius:6px; border:1px solid #ccc;">
			</div>

			<button id="applyItinerarySettings"
				style="height:40px; align-self:flex-end; background:#0077ff; color:white; border:none; border-radius:6px; cursor:pointer; padding:0 14px;">
				Applica
			</button>
		</div>


		<!-- Pulsanti utili (mappa + anteprima) -->
		<div style="display:flex; gap:10px; padding:15px;">

			<button id="showItineraryMapBtn" style="flex:1;">
				üó∫Ô∏è Mostra itinerario in mappa
			</button>

			<button id="previewBtn"
				style="flex:1; background:#f39c12; color:white; border:none; padding:10px 18px; border-radius:6px; cursor:pointer; font-size:15px;">
				üìÑ Anteprima
			</button>
			
			<button id="saveBtn"
				style="flex:1; background:#27ae60; color:white; border:none; padding:10px 18px; border-radius:6px; cursor:pointer;">
				üíæ Salva
			</button>

			<button id="loadBtn"
				style="flex:1; background:#8e44ad; color:white; border:none; padding:10px 18px; border-radius:6px; cursor:pointer;">
				üìÇ Carica
			</button>

			
		</div>

		<!-- Pulsante aggiungi giorno -->
		<div style="padding:15px;">
			<button id="addDayBtn"
				style="background:#27ae60; color:white; border:none; padding:10px 14px;
					   border-radius:6px; cursor:pointer; font-size:15px;">
				‚ûï Aggiungi giorno
			</button>
		</div>

		<!-- Contenitore giorni -->
		<div id="itinerary"></div>

	</div>



	<!-- ============================================================
		 MODALE ANTEPRIMA PREVENTIVO
		 ============================================================ -->
	<div id="previewModal">
		<div style="background:white; width:70%; max-height:80vh; overflow-y:auto; border-radius:10px; padding:20px;">

			<div style="display:flex; justify-content:space-between; margin-bottom:10px;">
				<h2>üìÑ Anteprima scheda preventivo</h2>
				<button onclick="closePreview()"
					style="background:red;color:white;border:none;padding:6px 10px;border-radius:6px;">‚úï</button>
			</div>

			<!-- Render dinamico contenuto -->
			<div id="previewContent"></div>
		</div>
	</div>



	<!-- ============================================================
		 MODALE "CERCA SULLA MAPPA" (catalogo)
		 ============================================================ -->
	<div id="mapModal">
		<div class="mapModalContent">

			<!-- Header -->
			<div style="padding:15px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between;">
				<h2>Cerca sulla mappa</h2>
				<button onclick="closeMapModal()">‚úï</button>
			</div>

			<!-- Filtri mappa -->
			<div style="padding:15px; display:flex; flex-wrap:wrap; gap:10px;">
				<select id="mapTypeSelector">
					<option value="places">Luoghi</option>
					<option value="structures">Strutture</option>
					<option value="activities">Attivit√†</option>
					<option value="transport">Trasporti</option>
				</select>

				<input id="mapSearchInput" placeholder="Titolo">
				<input id="mapDestinationInput" placeholder="Destinazione">
				<input id="mapSupplierInput" placeholder="Fornitore">

				<label>
					<input type="checkbox" id="mapShowPurchased"> Servizi gi√† in preventivo
				</label>

				<button onclick="renderMapResults()"
					style="background:#0077ff;color:white;border:none;padding:10px 15px;border-radius:6px;">
					üîé
				</button>
			</div>

			<!-- Mappa + lista risultati -->
			<div style="flex:1; display:flex; overflow:hidden;">

				<!-- Mappa -->
				<div id="modalMap" style="flex:2;"></div>

				<!-- Lista -->
				<div id="mapResultsList"
					style="flex:1; padding:15px; overflow-y:auto; border-left:1px solid #ddd;">
				</div>
			</div>
		</div>
	</div>



	<!-- ============================================================
		 MODALE MAPPA ITINERARIO (solo attivit√† & strutture)
		 ============================================================ -->
	<div id="itineraryMapModal">

		<div class="mapModalContent" style="flex-direction:row; display:flex;">

			<!-- Sidebar filtri giorni e tipologia -->
			<div style="width:260px; background:#fafafa; border-right:1px solid #ddd; padding:15px; overflow-y:auto;">
				<h3>Giorni itinerario</h3>

				<!-- Lista giorni generata via JS -->
				<div id="dayFilterList" style="margin-bottom:20px;"></div>

				<h3>Filtri</h3>

				<label>
					<input type="radio" name="typeFilter" value="all" checked>
					Mostra attivit√† e strutture
				</label><br>

				<label>
					<input type="radio" name="typeFilter" value="activities">
					Mostra solo attivit√†
				</label><br>

				<label>
					<input type="radio" name="typeFilter" value="structures">
					Mostra solo strutture
				</label><br>

				<button onclick="closeItineraryMapModal()"
					style="margin-top:20px; background:#e74c3c; color:white; padding:8px 12px; border:none; border-radius:6px; width:100%;">
					Chiudi
				</button>
			</div>

			<!-- Sezione mappa -->
			<div style="flex:1; display:flex; flex-direction:column;">
				<div style="padding:15px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between;">
					<h2>Mappa dell'itinerario</h2>
				</div>

				<div id="itineraryMap" style="flex:1;"></div>
			</div>
		</div>
	</div>



	<!-- ============================================================
		 JAVASCRIPT (inserito nei prossimi blocchi)
		 ============================================================ -->
	<script>



	/* BLOCCO 3 COMPLETO COMMENTATO */

	/* ============================================================
	   CATALOGO DATI (places, activities, structures, transport)
	   ============================================================ */
	/*
	   Ogni voce contiene:
	   - id: identificativo univoco
	   - title: titolo mostrato nel catalogo
	   - desc: descrizione sintetica
	   - destination: destinazione associata
	   - supplier: fornitore del servizio
	   - lat/lon: coordinate geografiche per la mappa
	*/

	const data = {

		/* ---------------------------
		   LUOGHI (places)
		   --------------------------- */
		places: [
			{ id:"p1", title:"New York", desc:"Metropoli iconica.", destination:"New York", supplier:"-", lat:40.7128, lon:-74.0060 },
			{ id:"p2", title:"Statua della Libert√†", desc:"Simbolo USA.", destination:"New York", supplier:"-", lat:40.6892, lon:-74.0445 },
			{ id:"p3", title:"Central Park", desc:"Il parco urbano pi√π famoso del mondo.", destination:"New York", supplier:"-", lat:40.7851, lon:-73.9683 },
			{ id:"p4", title:"Tokyo Tower", desc:"Torre panoramica simbolo di Tokyo.", destination:"Tokyo", supplier:"-", lat:35.6586, lon:139.7454 },
			{ id:"p5", title:"Shinjuku", desc:"Quartiere moderno di Tokyo.", destination:"Tokyo", supplier:"-", lat:35.6938, lon:139.7034 },
			{ id:"p6", title:"Kyoto Fushimi Inari", desc:"Santuario con migliaia di torii rossi.", destination:"Kyoto", supplier:"-", lat:34.9671, lon:135.7727 },
			{ id:"p7", title:"Shibuya Crossing", desc:"L'incrocio pi√π trafficato del mondo.", destination:"Tokyo", supplier:"-", lat:35.6594, lon:139.7003 },
			{ id:"p8", title:"Londra Westminster", desc:"Zona monumentale di Londra.", destination:"Londra", supplier:"-", lat:51.4995, lon:-0.1248 },
			{ id:"p9", title:"Tower Bridge", desc:"Ponte simbolo di Londra.", destination:"Londra", supplier:"-", lat:51.5055, lon:-0.0754 },
			{ id:"p10", title:"Tour Eiffel", desc:"Simbolo di Parigi.", destination:"Parigi", supplier:"-", lat:48.8584, lon:2.2945 },
			{ id:"p11", title:"Louvre", desc:"Il museo pi√π famoso del mondo.", destination:"Parigi", supplier:"-", lat:48.8606, lon:2.3376 },
			{ id:"p12", title:"Burj Khalifa", desc:"Il grattacielo pi√π alto del mondo.", destination:"Dubai", supplier:"-", lat:25.1972, lon:55.2744 },
			{ id:"p13", title:"Dubai Marina", desc:"Area futuristica sul mare.", destination:"Dubai", supplier:"-", lat:25.0800, lon:55.1400 },
			{ id:"p14", title:"Sydney Opera House", desc:"Iconico teatro sul mare.", destination:"Sydney", supplier:"-", lat:-33.8568, lon:151.2153 },
			{ id:"p15", title:"Bondi Beach", desc:"La spiaggia pi√π famosa di Sydney.", destination:"Sydney", supplier:"-", lat:-33.8915, lon:151.2767 },
			{ id:"p16", title:"Rio de Janeiro ‚Äì Cristo Redentore", desc:"Una delle 7 meraviglie del mondo.", destination:"Rio", supplier:"-", lat:-22.9519, lon:-43.2105 },
			{ id:"p17", title:"Reykjavik Blue Lagoon", desc:"Sorgente termale islandese.", destination:"Reykjavik", supplier:"-", lat:63.8804, lon:-22.4495 },
			{ id:"p18", title:"Marrakech Medina", desc:"Mercati tradizionali marocchini.", destination:"Marrakech", supplier:"-", lat:31.6295, lon:-7.9811 },
			{ id:"p19", title:"Roma Colosseo", desc:"Simbolo dell'antica Roma.", destination:"Roma", supplier:"-", lat:41.8902, lon:12.4922 },
			{ id:"p20", title:"Firenze Duomo", desc:"Capolavoro rinascimentale.", destination:"Firenze", supplier:"-", lat:43.7731, lon:11.2560 },
			{ id:"ma_p1", title:"Essaouira", desc:"Localit√† marocchina", destination:"Marocco", supplier:"-", lat:31.5085, lon:-9.7595 },
			{ id:"ma_p2", title:"Agafay", desc:"Deserto roccioso vicino a Marrakech", destination:"Marocco", supplier:"-", lat:31.3850, lon:-8.2590 },
			{ id:"ma_p3", title:"Marrakech", desc:"Citt√† imperiale del Marocco", destination:"Marocco", supplier:"-", lat:31.6295, lon:-7.9811 },
			{ id:"ma_p4", title:"Ourika", desc:"Valle dell'Ourika", destination:"Marocco", supplier:"-", lat:31.2262, lon:-7.6736 },
			{ id:"ma_p5", title:"A√Øt Ben Haddou", desc:"Ksar patrimonio UNESCO", destination:"Marocco", supplier:"-", lat:31.0470, lon:-7.1310 },
			{ id:"ma_p6", title:"Skoura", desc:"Oasi e palmeti di Skoura", destination:"Marocco", supplier:"-", lat:31.0635, lon:-6.5324 },
			{ id:"ma_p7", title:"Dades", desc:"Valle del Dad√®s", destination:"Marocco", supplier:"-", lat:31.3600, lon:-6.3100 },
			{ id:"ma_p8", title:"Merzouga", desc:"Dune del Sahara", destination:"Marocco", supplier:"-", lat:31.0994, lon:-4.0116 },
			{ id:"ma_p9", title:"Fes", desc:"Antica citt√† imperiale", destination:"Marocco", supplier:"-", lat:34.0181, lon:-5.0078 },
			{ id:"ma_p10", title:"Chefchaouen", desc:"La citt√† blu", destination:"Marocco", supplier:"-", lat:35.1686, lon:-5.2636 },
			{ id:"ma_p11", title:"Tangeri", desc:"Grande citt√† del nord", destination:"Marocco", supplier:"-", lat:35.7595, lon:-5.8339 },
			{ id:"ma_p12", title:"Cairo", desc:"Arrivo a Il Cairo, disbrigo delle formalit√† doganali, incontro con l‚Äôaccompagnatore locale e trasferimento in albergo con un veicolo privato. Assegnazione delle camere, serata libera.", destination:"Egitto, Cairo", supplier:"-", lat:35.7595, lon:-5.8339 }
			
			
		],

		/* ---------------------------
		   ATTIVIT√Ä (activities)
		   --------------------------- */
		activities: [
			{ id:"a1", title:"Tour della Grande Mela", desc:"Tour guidato completo di Manhattan.", destination:"New York", supplier:"NYC Tours", lat:40.758, lon:-73.985 },
			{ id:"a2", title:"Ground Zero Tour", desc:"Visita al memoriale 9/11.", destination:"New York", supplier:"Liberty Excursions", lat:40.7115, lon:-74.0134 },
			{ id:"a3", title:"Crociera Hudson", desc:"Mini crociera panoramica.", destination:"New York", supplier:"NY Cruises", lat:40.705, lon:-74.013 },
			{ id:"a4", title:"Cooking Class Ramen", desc:"Lezione di cucina tradizionale.", destination:"Tokyo", supplier:"Tokyo Food Lab", lat:35.6895, lon:139.6917 },
			{ id:"a5", title:"Tour Geisha District", desc:"Passeggiata nel quartiere Gion.", destination:"Kyoto", supplier:"Japan Culture", lat:35.0023, lon:135.7788 },
			{ id:"a6", title:"Safari nel deserto", desc:"Escursione in 4x4 e cena beduina.", destination:"Dubai", supplier:"Desert Safari UAE", lat:25.2048, lon:55.2708 },
			{ id:"a7", title:"Opera di Sydney Tour", desc:"Visita guidata interna.", destination:"Sydney", supplier:"Sydney Opera House", lat:-33.8568, lon:151.2153 },
			{ id:"a8", title:"Lezione Surf Bondi", desc:"Corso base con istruttore.", destination:"Sydney", supplier:"Bondi Surf School", lat:-33.8915, lon:151.2767 },
			{ id:"a9", title:"Tour favela Rocinha", desc:"Esperienza sociale guidata.", destination:"Rio", supplier:"Rio Local Tours", lat:-22.9833, lon:-43.2167 },
			{ id:"a10", title:"Escursione ghiacciai", desc:"Tour nella natura islandese.", destination:"Reykjavik", supplier:"Arctic Adventures", lat:64.1265, lon:-21.8174 },
			{ id:"a11", title:"Hammam tradizionale", desc:"Percorso benessere arabo.", destination:"Marrakech", supplier:"Spa Medina", lat:31.63, lon:-7.98 },
			{ id:"a12", title:"Tour Vaticano", desc:"Musei Vaticani + Cappella Sistina.", destination:"Roma", supplier:"Roma Guide", lat:41.9022, lon:12.4539 },
			{ id:"a13", title:"Times Square", desc:"Times Square.", destination:"Roma", supplier:"New York", lat:41.9022, lon:12.4539 },
			{ id:"a14", title:"Tour di El Fayoum e Wadi El Rayan - CAIRO", desc:"Dopo colazione, un veicolo privato ci porter√† a Fayoum, a circa 95 km dal Cairo. Inizieremo il tour nell‚Äôarea protetta di Wadi Hitan (Valle delle Balene), situata all‚Äôinterno della riserva di Wadi El Rayan e riconosciuta dall‚ÄôUNESCO come patrimonio mondiale per gli scheletri di balene risalenti a 40 milioni di anni fa. Proseguiremo verso le cascate di Wadi El Rayan, che si trovano in una depressione naturale nel deserto occidentale, 42 metri sotto il livello del mare. Arrivati a Fayoum, sar√† possibile provare il sandboarding. Rientro in hotel nel pomeriggio, con tempo libero per la serata. Cena libera.", destination:"Egitto, Cairo", supplier:"Cairo Tours", lat:41.9022, lon:12.4539 },
			{ id:"a14", title:"Tour privato del Grande Museo Egizio e Cittadella - CAIro", desc:"Dopo colazione, un veicolo privato ci condurr√† al Grande Museo Egizio (GEM), situato vicino alle Piramidi di Giza. Il museo, all‚Äôavanguardia, racconta la ricca storia dell‚ÄôEgitto. Progettato per ospitare oltre 100.000 reperti, esporr√† per la prima volta insieme, da novembre 2025, l‚Äôintera collezione dei tesori del re Tutankhamon. Dopo la visita al museo, ci sar√† tempo per esplorare la storica Cittadella di Salah El Din, dove potrai ammirare la magnifica Moschea di Mohamed Ali e godere di viste mozzafiato sul Cairo. Rientro in hotel nel pomeriggio, tempo libero per la sera. Cena libera.", destination:"Egitto, Cairo", supplier:"Cairo Tours", lat:41.9022, lon:12.4539 },
			{ id:"a15", title:"Tour Piramidi di Giza, Menfi e Sakkara - CAIRO", desc:"Dopo colazione, un veicolo privato con una guida egittologa esperta ci porter√† al ‚ÄúThe Giza Plateau‚Äù, dove potrete ammirare l‚Äôiconico panorama delle grandi piramidi e della Sfinge. Successivamente, ci dirigeremo verso l‚Äôantica capitale di Menfi, sede di affascinanti statue e reperti, incluso il notevole colosso di Ramses II. Infine, esploreremo Saqqara, dove visiteremo la piramide a gradoni di Djoser, la pi√π antica struttura in pietra su larga scala della storia. Rientro in hotel nel pomeriggio e tempo libero per la sera. Cena libera.", destination:"Egitto, Cairo", supplier:"Cairo Tours", lat:41.9022, lon:12.4539 },
			{ id:"a15", title:"Scoperta del Vecchio Cairo", desc:"Dopo colazione, il nostro tour ci condurr√† alla scoperta della storia della citt√†, visitando alcuni dei suoi siti pi√π iconici. Esploreremo la Sinagoga Ben Ezra, la Chiesa di Santa Barbara e la Chiesa di Abu Serga. Avremo tempo per passeggiare lungo ‚ÄúEl Moez Le Din Allah‚Äù, una delle strade pi√π antiche d‚ÄôEgitto, che rappresenta il cuore storico del Cairo, con monumenti come Bab El Fetouh e Bab El Nasr su entrambi i lati. Proseguiremo verso il quartiere pi√π antico della citt√†, El Darb El Asfar, famoso per i suoi monumenti islamici. Infine, visiteremo i vivaci bazar di Khan El Khalili, noti per oggetti in ottone, rame, profumi, cuoio, argento, oro e antiquariato. A met√† pomeriggio, trasferimento all‚Äôaeroporto.", destination:"Egitto, Cairo", supplier:"Cairo Tours", lat:41.9022, lon:12.4539 }
			
			
			
		],

		/* ---------------------------
		   STRUTTURE (hotels & lodges)
		   --------------------------- */
		structures: [
			{ id:"s1", title:"Hotel Crystal NYC", desc:"Hotel moderno nel cuore di Manhattan.", destination:"New York", supplier:"Crystal Hotels", lat:40.754, lon:-73.984 },
			{ id:"s2", title:"Hilton Times Square", desc:"Hotel premium.", destination:"New York", supplier:"Hilton", lat:40.761, lon:-73.981 },
			{ id:"s3", title:"Tokyo Ryokan Sakura", desc:"Alloggio tradizionale giapponese.", destination:"Tokyo", supplier:"Ryokan Group", lat:35.6895, lon:139.692 },
			{ id:"s4", title:"Kyoto Riverside Hotel", desc:"Boutique hotel romantico.", destination:"Kyoto", supplier:"KyoStay", lat:35.0116, lon:135.7681 },
			{ id:"s5", title:"Dubai Palm Resort", desc:"Resort 5‚òÖ su The Palm.", destination:"Dubai", supplier:"Palm Resorts", lat:25.112, lon:55.138 },
			{ id:"s6", title:"Sydney Harbour Hotel", desc:"Camere vista Opera House.", destination:"Sydney", supplier:"Harbour Hotels", lat:-33.857, lon:151.212 },
			{ id:"s7", title:"Rio Copacabana Resort", desc:"Resort fronte mare.", destination:"Rio", supplier:"Tropical Resorts", lat:-22.9711, lon:-43.1822 },
			{ id:"s8", title:"Iceland Glacier Lodge", desc:"Lodge nordico nel ghiaccio.", destination:"Reykjavik", supplier:"Nordic Stay", lat:64.13, lon:-21.82 },
			{ id:"s9", title:"Riad Marrakech Rose", desc:"Riad tradizionale nella Medina.", destination:"Marrakech", supplier:"Riad Collection", lat:31.63, lon:-7.99 },
			{ id:"s10", title:"Roma Boutique Hotel", desc:"Elegante boutique hotel.", destination:"Roma", supplier:"Roma Hotels", lat:41.90, lon:12.50 },
			{ id:"ma_s1", title:"Le Jardin des Douars", desc:"Boutique hotel a Essaouira", destination:"Marocco", supplier:"Le Jardin des Douars", lat:31.5085, lon:-9.7595 },
			{ id:"ma_s2", title:"Inara Camp", desc:"Luxury camp nel deserto di Agafay", destination:"Marocco", supplier:"Inara Camp", lat:31.3850, lon:-8.2590 },
			{ id:"ma_s3", title:"Ksar Kasbah & Spa", desc:"Riad di charme a Marrakech", destination:"Marocco", supplier:"Ksar Kasbah", lat:31.6295, lon:-7.9811 },
			{ id:"ma_s4", title:"Kasbah Africa", desc:"Eco-lodge nella valle dell‚ÄôOurika", destination:"Marocco", supplier:"Kasbah Africa", lat:31.2262, lon:-7.6736 },
			{ id:"ma_s5", title:"Kasbah Tamsna", desc:"Kasbah tradizionale ad A√Øt Ben Haddou", destination:"Marocco", supplier:"Kasbah Tamsna", lat:31.0470, lon:-7.1310 },
			{ id:"ma_s6", title:"L'Ma Lodge", desc:"Boutique lodge a Skoura", destination:"Marocco", supplier:"L'Ma Lodge", lat:31.0635, lon:-6.5324 },
			{ id:"ma_s7", title:"Auberge Chez Pierre", desc:"Lodge nella valle del Dad√®s", destination:"Marocco", supplier:"Auberge Chez Pierre", lat:31.3600, lon:-6.3100 },
			{ id:"ma_s8", title:"Luxury Traditional Tent Camp", desc:"Campo tendato tradizionale a Merzouga", destination:"Marocco", supplier:"Nomad Luxury Camp", lat:31.0994, lon:-4.0116 },
			{ id:"ma_s9", title:"Dar Seffarine", desc:"Riad storico nel cuore di Fes", destination:"Marocco", supplier:"Dar Seffarine", lat:34.0181, lon:-5.0078 },
			{ id:"ma_s10", title:"Dar Jasmine", desc:"Boutique hotel panoramico", destination:"Marocco", supplier:"Dar Jasmine", lat:35.1686, lon:-5.2636 },
			{ id:"ma_s11", title:"Hotel 4 stelle ", desc:"Bed & Breakfast / Camera doppia", destination:"Egitto, Cairo", supplier:"Hotel generico 4 stelle", lat:35.1686, lon:-5.2636 }
			
		],

		/* ---------------------------
		   TRASPORTI
		   --------------------------- */
		transport: [
			{ id:"t1", title:"Volo FCO-JFK", desc:"Volo diretto Roma ‚Üí NYC.", destination:"New York", supplier:"Alitalia", lat:40.641, lon:-73.778 },
			{ id:"t2", title:"Volo JFK-FCO", desc:"Ritorno NYC ‚Üí Roma.", destination:"Roma", supplier:"Alitalia", lat:41.80, lon:12.2389 },
			{ id:"t3", title:"Transfer JFK-Manhattan", desc:"Trasferimento privato.", destination:"New York", supplier:"AirportConnect", lat:40.641, lon:-73.778 },
			{ id:"t4", title:"Shinkansen Tokyo-Kyoto", desc:"Treno alta velocit√†.", destination:"Tokyo", supplier:"JR Line", lat:35.6812, lon:139.7671 },
			{ id:"t5", title:"Transfer Dubai Hotel", desc:"Trasferimento aeroporto ‚Üí hotel.", destination:"Dubai", supplier:"DXB Transport", lat:25.2532, lon:55.3657 },
			{ id:"t6", title:"Volo SYD-RIO", desc:"Sydney ‚Üí Rio (1 stop).", destination:"Rio", supplier:"Qantas", lat:-33.9399, lon:151.1753 },
			{ id:"t7", title:"Bus Reykjavik Tour", desc:"Trasporto per escursioni.", destination:"Reykjavik", supplier:"Arctic Bus", lat:64.13, lon:-21.82 },
			{ id:"t8", title:"Taxi Roma Aeroporto", desc:"Taxi ufficiale Roma FCO.", destination:"Roma", supplier:"Taxi Roma", lat:41.80, lon:12.2389 },
			{ id:"t9", title:"Volo CDG-DXB", desc:"Parigi ‚Üí Dubai.", destination:"Dubai", supplier:"Emirates", lat:48.8566, lon:2.3522 },
			{ id:"t10", title:"Ferry Sydney Harbour", desc:"Traghetto panoramico.", destination:"Sydney", supplier:"Harbour Ferry", lat:-33.852, lon:151.211 },
			{ id:"t11", title:"Volo CAI-FCO", desc:"17:55 Cairo, Cairo International Airport --> 20:30 Rome, Leonardo da Vinci-Fiumicino Airport ", destination:"Italia, Roma", supplier:"Ita Airways", lat:-33.852, lon:151.211 },
			{ id:"t12", title:"Volo FCO-FLR", desc:"21:45 Rome, Leonardo da Vinci-Fiumicino Airport --> 22:40 Florence, Amerigo Vespucci Airport", destination:"Italia, Firenze", supplier:"Ita Airways", lat:-33.852, lon:151.211 },
			{ id:"t13", title:"Volo FLR-FCO", desc:"06:25 Florence, Amerigo Vespucci Airport --> 07;15 Rome, Leonardo da Vinci-Fiumicino Airport Cairo, Cairo International Airport", destination:"Italia, Roma", supplier:"Ita Airways", lat:-33.852, lon:151.211 },
			{ id:"t14", title:"Volo FCO-CAI", desc:"12:40 Rome, Leonardo da Vinci-Fiumicino  --> 15:55 Airport Cairo, Cairo International Airport", destination:"Egitto, Cairo", supplier:"Ita Airways", lat:-33.852, lon:151.211 }
			
		]
	};



	/* ============================================================
	   MARCATURA ELEMENTI "gi√† acquistati"
	   (usata per filtri e icone)
	   ============================================================ */
	function markRandomBought() {
		["structures", "activities", "transport"].forEach(sec => {
			let arr = data[sec];
			for (let i = 0; i < Math.ceil(arr.length / 2); i++) {
				arr[Math.floor(Math.random() * arr.length)].bought = true;
			}
		});
	}
	markRandomBought();



	/* ============================================================
	   UTILITY: icone e ribbon "‚úî inserito"
	   ============================================================ */

	/** Restituisce l'icona SVG corretta */
	function icon(type) {
		return `<svg class='icon'><use href='#icon-${type === "places"
			? "place"
			: type === "structures"
			? "hotel"
			: type === "activities"
			? "activity"
			: "transport"}'/></svg>`;
	}

	/** Ribbon mostrato quando un servizio √® gi√† nell‚Äôitinerario */
	function ribbon(item) {
		if (insertedTitles.has(item.title)) {
			return `<div class="ribbon" style="background:#2ecc71; transform:rotate(0deg);">
						‚úî Inserito
					</div>`;
		}
		return "";
	}



	/* ============================================================
	   FUNZIONE FILTRO CATALOGO
	   ============================================================ */
	/*
	   Filtra per:
	   - testo nel titolo o nella descrizione
	   - destinazione
	   - fornitore
	   - eventuale filtro "purchased"
	*/

	function filter(items, t, d, s, p) {
		return items.filter(x =>
			(
				x.title.toLowerCase().includes(t) ||
				x.desc.toLowerCase().includes(t)  // ricerca ampliata
			)
			&& x.destination.toLowerCase().includes(d)
			&& x.supplier.toLowerCase().includes(s)
			&& (!p || x.bought)
		);
	}



	/* ============================================================
	   RENDER CATALOGO
	   ============================================================ */
	searchBtn.onclick = render;

	function render() {

		const type = typeSelector.value;
		const t = searchInput.value.toLowerCase();
		const d = destinationInput.value.toLowerCase();
		const s = supplierInput.value.toLowerCase();
		const p = showPurchased.checked;
		const onlyInserted = document.getElementById("showInserted").checked;

		results.innerHTML = "";

		// Se "Tutti" ‚Üí unisce tutti i dataset
		let itemsToSearch = [];

		if (type === "all") {
			itemsToSearch = [
				...data.places,
				...data.structures,
				...data.activities,
				...data.transport
			];
		} else {
			itemsToSearch = data[type];
		}

		// Esegui il filtro e genera risultati
		filter(itemsToSearch, t, d, s, p)
			.filter(item => !onlyInserted || insertedTitles.has(item.title))
			.forEach(item => {

				let el = document.createElement("div");
				let typeOfItem = Object.keys(data).find(k => data[k].includes(item));

				el.className = "result-card";
				el.draggable = true;

				el.innerHTML = `
					${ribbon(item)}
					${icon(typeOfItem)}
					<div>
						<strong>${item.title}</strong><br>
						${item.desc}<br>
						<small>${item.destination} ‚Ä¢ ${item.supplier}</small>
					</div>
				`;

				// Drag & drop verso l'itinerario
				el.addEventListener("dragstart", e => {
					e.dataTransfer.setData("fromCatalog", "true");
					e.dataTransfer.setData("title", item.title);
					e.dataTransfer.setData("desc", item.desc);
				});

				results.appendChild(el);
			});
	}



	/* ============================================================
	   COSTRUZIONE ITINERARIO (lista giorni)
	   ============================================================ */
	function formattaDataGGMMYYYY(date) {
	  const gg = String(date.getDate()).padStart(2, "0");
	  const mm = String(date.getMonth() + 1).padStart(2, "0");
	  const yyyy = date.getFullYear();
	  return `${gg}/${mm}/${yyyy}`;
	}

	function buildItinerary() {

		const giorniSettimana = [
		  "Domenica",
		  "Luned√¨",
		  "Marted√¨",
		  "Mercoled√¨",
		  "Gioved√¨",
		  "Venerd√¨",
		  "Sabato"
		];


		itinerary.innerHTML = "";

		// Se l'utente non seleziona data ‚Üí usa quella odierna
		let startInput = document.getElementById("startDate").value;
		let start = startInput ? new Date(startInput) : null;


		let daysInput = parseInt(document.getElementById("numDays").value) || 10;

		if (daysInput > 14) {
			alert("Numero massimo consentito di giorni: 14");
		}

		let days = Math.min(daysInput, 14);



		for (let i = 1; i <= days; i++) {

			// Calcolo data giorno i
			let d = null;

			if (start) {
				// Se l'utente ha scelto una data, calcoliamo quella corretta
				d = new Date(start);
				d.setDate(start.getDate() + (i - 1));
			}


			// Struttura contenitore del giorno
			let box = document.createElement("div");
			box.className = "day-box";

			let label;

			if (start) {
				const dataFormattata = formattaDataGGMMYYYY(d);
				const nomeGiorno = giorniSettimana[d.getDay()];
				label = `Giorno ${i} ‚Äì ${dataFormattata} - ${nomeGiorno}`;
			} else {
				label = `Giorno ${i}`;
			}



			box.innerHTML = `
			  <div class='day-title'>
				<input class="day-title-input" value="${label}" id="day-title-${i}">
				<span class="day-icons" id="day-icons-${i}" style="margin-left:10px;"></span>

				<button class="delete-day-btn" data-day="${i}"
					style="float:right; background:#e74c3c; color:white; border:none;
						   padding:4px 8px; border-radius:4px; cursor:pointer;">
					üóë
				</button>
			  </div>

			  <div class='drop-area' id='day-${i}'></div>
			`;



			itinerary.appendChild(box);

			let drop = box.querySelector(".drop-area");

			// Permette il drop
			drop.addEventListener("dragover", e => e.preventDefault());
			
			

			/* Gestione drop da catalogo */
			drop.addEventListener("drop", e => {
				e.preventDefault();

				if (e.dataTransfer.getData("fromCatalog") === "true") {

					let t = e.dataTransfer.getData("title");
					let desc = e.dataTransfer.getData("desc");

					let di = document.createElement("div");
					di.className = "day-item";

				let type = Object.keys(data).find(k => data[k].some(x => x.title === t));

				let extraFields = "";

				if (type === "activities") {
					extraFields = `
					<div class="time-inline">
						‚è± 
						<label>Inizio</label>
						<input type="time" class="start-time">

						<label>Fine</label>
						<input type="time" class="end-time">

						<label>Durata</label>
						<input type="number" class="duration">
						
						<label>Note</label>
						<input type="text">						
					</div>
				`;
				}
				

				di.innerHTML = `
					<input value='${t}'>

					<textarea rows='2'>${desc}</textarea>

					${extraFields}

				<div class="images-area" style="margin-top:8px;">
						<button class="add-image-btn"
								style="
								margin-bottom:6px;
								background:#007bff;
								border:none;
								padding:6px 10px;
								border-radius:6px;
								cursor:pointer;
								color:white;
								font-size:13px;
								font-weight:600;
								display:inline-flex;
								align-items:center;
								gap:6px;
							">
							‚ûï Aggiungi immagini
						</button>

						<div class="img-container"></div>
					</div>

					<button class="remove-btn">‚úï</button>
				`;
				
				const addImgBtn = di.querySelector(".add-image-btn");
				const imgContainer = di.querySelector(".img-container");

				addImgBtn.onclick = () => {
					let input = document.createElement("input");
					input.type = "file";
					input.accept = "image/*";
					input.onchange = e => handleImageUpload(e, imgContainer);
					input.click();
				};



					drop.appendChild(di);

					// Registra come inserito
					insertedTitles.add(t);

					// Rimozione
					di.querySelector(".remove-btn").onclick = () => {
						di.remove();
						removeFromItinerary(di, t);
						updateDayIcons(i);
					};

					updateDayIcons(i);
					render();
				}
			});

			// Drag & drop tra giorni diversi
			Sortable.create(drop, {
			  animation: 150,
			  group: "itinerary",

			  // FIX PER MOBILE (iOS + Android)
			  forceFallback: true,
			  fallbackOnBody: true,
			  fallbackTolerance: 3,
			  touchStartThreshold: 0,

			  onSort: () => updateDayIcons(i)
			});



			updateDayIcons(i);
			
			attachDayDeleteHandlers();
		}
	}

	/* Pulsante "Applica" rigenera l'itinerario */
	applyItinerarySettings.onclick = () => buildItinerary();
	
	// Aggiungi un nuovo giorno all'itinerario esistente
	document.getElementById("addDayBtn").onclick = () => {
    const itinerary = document.getElementById("itinerary");
    const totalDays = itinerary.querySelectorAll(".day-box").length;

    const newDay = totalDays + 1;

    // Calcolo data se presente startDate
    let startInput = document.getElementById("startDate").value;
    let dayLabel = `Giorno ${newDay}`;

    if (startInput) {
        let start = new Date(startInput);
        let newDate = new Date(start);
        newDate.setDate(start.getDate() + (newDay - 1));

        const giorniSettimana = ["Domenica","Luned√¨","Marted√¨","Mercoled√¨","Gioved√¨","Venerd√¨","Sabato"];
        const formatted = formattaDataGGMMYYYY(newDate);
        const dow = giorniSettimana[newDate.getDay()];

        dayLabel = `Giorno ${newDay} ‚Äì ${formatted} ‚Äì ${dow}`;
    }

    // Crea contenitore nuovo giorno
    let box = document.createElement("div");
    box.className = "day-box";

    box.innerHTML = `
      <div class='day-title'>
        <input class="day-title-input" value="${dayLabel}" id="day-title-${newDay}">
        <span class="day-icons" id="day-icons-${newDay}" style="margin-left:10px;"></span>

        <button class="delete-day-btn" data-day="${newDay}"
            style="float:right; background:#e74c3c; color:white; border:none;
                   padding:4px 8px; border-radius:4px; cursor:pointer;">
            üóë
        </button>
      </div>

      <div class='drop-area' id='day-${newDay}'></div>
    `;

    itinerary.appendChild(box);

    // Attiva drop e riordino anche sul nuovo giorno
    const drop = document.getElementById(`day-${newDay}`);

    drop.addEventListener("dragover", e => e.preventDefault());
    Sortable.create(drop, {
        animation: 150,
        group: "itinerary",
        forceFallback: true,
        fallbackOnBody: true,
        fallbackTolerance: 3,
		
		onSort: () => updateDayIcons(newDay)
    });
	
drop.addEventListener("drop", e => {
    e.preventDefault();

    if (e.dataTransfer.getData("fromCatalog") === "true") {

        const t = e.dataTransfer.getData("title");
        const desc = e.dataTransfer.getData("desc");

        let di = document.createElement("div");
        di.className = "day-item";

        di.innerHTML = `
            <input value='${t}'>
            <textarea rows='2'>${desc}</textarea>
            <button class="remove-btn">‚úï</button>
        `;

        drop.appendChild(di);

        // Marca come inserito
        insertedTitles.add(t);

        // Gestione rimozione
        di.querySelector(".remove-btn").onclick = () => {
            di.remove();
            removeFromItinerary(di, t);
            updateDayIcons(newDay);
        };

        updateDayIcons(newDay);
        render();
    }
});
	

    attachDayDeleteHandlers();
};



	/* ============================================================
	   GESTIONE ELEMENTI INSERITI / RIMOSSI
	   ============================================================ */

	// Insieme che contiene titoli dei servizi gi√† aggiunti
	let insertedTitles = new Set();

	/** Rimuove un elemento dall'itinerario verificando se presente altrove */
	function removeFromItinerary(box, title) {

		// Rimozione DOM
		box.remove();

		// Verifica se il titolo appare ancora in qualche altro giorno
		let stillPresent = false;

		for (let d = 1; d <= 10; d++) {
			document.querySelectorAll(`#day-${d} .day-item input`).forEach(inp => {
				if (inp.value === title) stillPresent = true;
			});
		}

		// Se non appare ‚Üí rimuovi dal set
		if (!stillPresent) {
			insertedTitles.delete(title);
		}

		render(); // aggiorna catalogo (per ribbon)
	}


	/* ============================================================
	   ICONE SINTETICHE NON OBBLIGATORIE (attivit√†/strutture/...)
	   ============================================================ */

	/*
	   Per ogni giorno mostra:
	   üéØ se include attivit√†
	   üè® se include strutture
	   üöï se include trasporti
	   üìç se include luoghi

	   Non impone obblighi, √® solo indicativo.
	*/

	function updateDayIcons(day) {

		let items = document.querySelectorAll(`#day-${day} .day-item`);

		let hasActivity = false;
		let hasStructure = false;
		let hasTransport = false;
		let hasPlace = false;

		items.forEach(el => {
			let title = el.querySelector("input").value;
			let type = Object.keys(data).find(k => data[k].some(x => x.title === title));

			if (type === "activities") hasActivity = true;
			if (type === "structures") hasStructure = true;
			if (type === "transport") hasTransport = true;
			if (type === "places") hasPlace = true;
		});

		let area = document.getElementById(`day-icons-${day}`);

		area.innerHTML = `
			${hasActivity ? "üéØ" : ""}
			${hasStructure ? "üè®" : ""}
			${hasTransport ? "üöï" : ""}
			${hasPlace ? "üìç" : ""}
		`;
	}

	/* BLOCCO 4 OSPITERANNO LO SCRIPT COMPLETO COMMENTATO */
	/* ============================================================
	   MODALE "CERCA SULLA MAPPA" (catalogo)
	   ============================================================ */

	let modalMap;
	let mapMarkers = [];

	/* Apertura modale mappa per cercare servizi */
	mapSearchBtn.onclick = () => {

		mapModal.style.display = "flex";

		setTimeout(() => {
			// Inizializzazione mappa solo la prima volta
			if (!modalMap) {
				modalMap = L.map("modalMap").setView([40.7128, -74.0060], 12);
				L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
					.addTo(modalMap);
			}

			modalMap.invalidateSize();
			renderMapResults();
		}, 150);
	};

	/* Chiusura modale mappa */
	function closeMapModal() {
		mapModal.style.display = "none";
	}


	/* ============================================================
	   ICON SET PER LA MAPPA
	   ============================================================ */

	const pins = {
		places: L.icon({
			iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",
			shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
			iconSize: [25, 41],
			iconAnchor: [12, 41]
		}),

		structures: L.icon({
			iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png",
			shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
			iconSize: [25, 41],
			iconAnchor: [12, 41]
		}),

		activities: L.icon({
			iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
			shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
			iconSize: [25, 41],
			iconAnchor: [12, 41]
		}),

		transport: L.icon({
			iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png",
			shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
			iconSize: [25, 41],
			iconAnchor: [12, 41]
		}),

		purchased: L.icon({
			iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
			shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
			iconSize: [25, 41],
			iconAnchor: [12, 41]
		})
	};


	/* ============================================================
	   RENDER RISULTATI NELLA MAPPA CATALOGO
	   ============================================================ */

	function renderMapResults() {

		const type = mapTypeSelector.value;
		const t = mapSearchInput.value.toLowerCase();
		const d = mapDestinationInput.value.toLowerCase();
		const s = mapSupplierInput.value.toLowerCase();
		const p = mapShowPurchased.checked;

		mapResultsList.innerHTML = "";

		// Rimuovi vecchi marker
		mapMarkers.forEach(m => modalMap.removeLayer(m));
		mapMarkers = [];

		// Filtra dataset selezionato
		filter(data[type], t, d, s, p).forEach(item => {

			/* --- COSTRUZIONE CARD LATERALE --- */
			let c = document.createElement("div");
			c.className = "modal-card";

			c.innerHTML = `
				${ribbon(item)}
				<strong>${item.title}</strong><br>
				${item.desc}<br>
				<small>${item.destination} ‚Ä¢ ${item.supplier}</small>
				<br><br>

				<label>Giorno:</label>
				<select id="daySelect-${item.id}">
					${
						(() => {
							// Trova tutti i giorni reali
							const dayBoxes = document.querySelectorAll(".day-box");

							return Array.from(dayBoxes).map((box, index) => {

								const dayNumber = index + 1;

								// Titolo personalizzato se presente
								const customTitle =
									box.querySelector(".day-title-input")?.value ||
									`Giorno ${dayNumber}`;

								return `<option value="${dayNumber}">${customTitle}</option>`;
							}).join("");

						})()
					}
				</select>



				<button onclick='addFromMap("${item.id}")'
					style="margin-top:6px; width:100%; padding:6px;
						   background:#28a745; color:white; border:none; border-radius:6px;">
					‚ûï Aggiungi
				</button>
			`;

			mapResultsList.appendChild(c);

			/* --- AGGIUNTA PIN SULLA MAPPA --- */
			let ic = pins[type];
			if (item.bought && type !== "places") ic = pins.purchased;

			let mk = L.marker([item.lat, item.lon], { icon: ic }).addTo(modalMap);
			mk.bindPopup(`<b>${item.title}</b><br>${item.desc}`);

			mapMarkers.push(mk);
		});
	}


	/* ============================================================
	   AGGIUNGI ALL‚ÄôITINERARIO DALLA MAPPA
	   ============================================================ */

	function addFromMap(id) {

		let g = document.getElementById(`daySelect-${id}`).value;
		let drop = document.getElementById(`day-${g}`);

		let item = Object.values(data).flat().find(x => x.id === id);

		let el = document.createElement("div");
		el.className = "day-item";

		let type = Object.keys(data).find(k => data[k].some(x => x.title === item.title));

		let extraFields = "";

		if (type === "activities") {
			extraFields = `
				<div class="time-block">
					<label>Ora inizio</label>
					<input type="time" class="start-time">

					<label>Ora fine</label>
					<input type="time" class="end-time">

					<label>Durata (minuti)</label>
					<input type="number" class="duration" min="0">
				</div>
			`;
		}

		el.innerHTML = `
			<input value='${item.title}'>
			<textarea rows='2'>${item.desc}</textarea>

			${extraFields}

			<button class="remove-btn">‚úï</button>
		`;


		drop.appendChild(el);

		// Segna come inserito
		insertedTitles.add(item.title);

		// Rimozione coerente
		el.querySelector(".remove-btn").onclick = () => {
			el.remove();
			removeFromItinerary(el, item.title);
			updateDayIcons(g);
		};

		updateDayIcons(g);
		render(); // Aggiorna catalogo (per ribbon ‚úî)
	}


	/* ============================================================
	   MAPPA ITINERARIO (solo attivit√† e strutture)
	   ============================================================ */

	let itineraryMap;
	let itineraryMarkers = [];

	// Giorno attualmente visualizzato nella mappa
	let selectedDay = 1;

	/* Apertura modale "Mappa itinerario" */
	showItineraryMapBtn.onclick = () => {

		itineraryMapModal.style.display = "flex";

		if (!itineraryMap) {
			itineraryMap = L.map("itineraryMap").setView([40.7128, -74.0060], 10);
			L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
				.addTo(itineraryMap);
		}

		buildDaySidebar();
		renderItineraryPins();
	};

	/* Chiusura modale mappa itinerario */
	function closeItineraryMapModal() {
		itineraryMapModal.style.display = "none";
	}


	/* ============================================================
	   RENDER PIN ITINERARIO
	   ============================================================ */

	function renderItineraryPins() {

		// Rimuovi marker precedenti
		itineraryMarkers.forEach(m => itineraryMap.removeLayer(m));
		itineraryMarkers = [];

		let bounds = [];

		// Tipo filtrato nella sidebar
		const typeFilter = document.querySelector('input[name="typeFilter"]:checked')?.value || "all";

		// Cicla gli elementi del giorno selezionato
		const dayArea = document.getElementById(`day-${selectedDay}`);
			if (!dayArea) return; // il giorno non esiste pi√π

			dayArea.querySelectorAll(".day-item").forEach(el => {

			let title = el.querySelector("input").value;

			let item = Object.values(data).flat().find(x => x.title === title);
			if (!item) return;

			// Identifica categoria dell‚Äôelemento
			let type = Object.keys(data).find(k => data[k].some(x => x.title === title));

			// La mappa dell‚Äôitinerario mostra SOLO attivit√† e strutture
			if (type === "places" || type === "transport") return;

			// Applicazione filtro utente
			if (typeFilter !== "all" && type !== typeFilter) return;

			// Icona corretta
			let ic = pins[type];
			if (item.bought) ic = pins.purchased;

			// Aggiungi marker
			let mk = L.marker([item.lat, item.lon], { icon: ic }).addTo(itineraryMap);
			mk.bindPopup(`<b>${item.title}</b><br>${item.desc}`);
			itineraryMarkers.push(mk);

			bounds.push([item.lat, item.lon]);
		});

		// Adatta viewport
		if (bounds.length > 0) {
			itineraryMap.fitBounds(bounds, { padding: [40, 40] });
		}
	}


	/* ============================================================
	   SIDEBAR DEI GIORNI PER LA MAPPA ITINERARIO
	   ============================================================ */

	function buildDaySidebar() {

		const dayBoxes = document.querySelectorAll(".day-box");
		let html = "";

		dayBoxes.forEach((box, index) => {

			const dayNumber = index + 1;

			// Legge il valore personalizzato del titolo
			const customTitle =
				box.querySelector(".day-title-input")?.value ||
				`Giorno ${dayNumber}`;

			html += `
				<div style="padding:6px 0; cursor:pointer;"
					 onclick="selectedDay=${dayNumber}; renderItineraryPins();">
					‚û§ ${customTitle}
				</div>
			`;
		});

		document.getElementById("dayFilterList").innerHTML = html;

		if (selectedDay > dayBoxes.length) {
			selectedDay = 1;
		}
	}




	/* ============================================================
	   ANTEPRIMA PREVENTIVO
	   ============================================================ */

	previewBtn.onclick = openPreview;

	/* Apertura modale anteprima */
	function openPreview() {
		renderPreview();
		document.getElementById("previewModal").style.display = "flex";
	}

	/* Chiudi anteprima */
	function closePreview() {
		document.getElementById("previewModal").style.display = "none";
	}

	/* Render contenuto anteprima */
	function renderPreview() {

    let html = "";

    // Trova tutti i giorni reali presenti nell‚Äôitinerario
    const dayBoxes = document.querySelectorAll(".day-box");

    dayBoxes.forEach(box => {

        // Titolo giorno (editabile)
        const dayTitle = box.querySelector(".day-title-input")?.value ||
                         box.querySelector(".day-title")?.textContent ||
                         "Giorno";

        // Area contenuti
        const dropArea = box.querySelector(".drop-area");
        if (!dropArea) return;

        // Estrai day-items come array
        let items = Array.from(dropArea.querySelectorAll(".day-item"));

        // Ordina per orario di inizio
        items.sort((a, b) => {
            let aStart = a.querySelector(".start-time")?.value || "";
            let bStart = b.querySelector(".start-time")?.value || "";

            if (aStart === "" && bStart === "") return 0;
            if (aStart === "") return 1;
            if (bStart === "") return -1;
            return aStart.localeCompare(bStart);
        });

        if (items.length === 0) return;

        // --- Stampa il giorno ---
        html += `<h3 style="margin-top:20px; margin-bottom:5px;">${dayTitle}</h3>`;
        html += `<div style="padding-left:10px;">`;

        // --- Stampa i dettagli ---
        items.forEach(el => {

            let title = el.querySelector(".title-field")?.value ||
                        el.querySelector("input")?.value || "";

            let desc = el.querySelector("textarea")?.value || "";

            let start = el.querySelector(".start-time")?.value || "";
            let end   = el.querySelector(".end-time")?.value || "";
            let dur   = el.querySelector(".duration")?.value || "";

            // üéØ ORARI / DURATA
            let timeInfo = "";
            
            if (start && end) {
                timeInfo = `<div style="color:#0077ff;">‚è± ${start} ‚Üí ${end}</div>`;
            }
            else if (dur) {
                timeInfo = `<div style="color:#0077ff;">‚è± Durata: ${dur}</div>`;
            }

            // üéØ IMMAGINI
            let imgs = el.querySelectorAll(".detail-img");
            let imgHtml = "";

            if (imgs.length > 0) {
                imgHtml += `<div style="margin-top:6px;">`;
                imgs.forEach(im => {
                    imgHtml += `
                        <img src="${im.src}"
                             style="width:80px; height:80px; object-fit:cover;
                                    border-radius:6px; margin-right:6px;">
                    `;
                });
                imgHtml += `</div>`;
            }

            html += `
                <div style="margin-bottom:12px;">
                    ‚Ä¢ <strong>${title}</strong><br>
                    <span style="color:#555;">${desc}</span>
                    ${timeInfo}
                    ${imgHtml}
                </div>
            `;
        });

        html += `</div>`;
    });

    if (html.trim() === "") {
        html = "<p>Nessun servizio inserito nell‚Äôitinerario.</p>";
    }

    document.getElementById("previewContent").innerHTML = html;
}




	/* ============================================================
	   COLLASSA SEZIONE FILTRI DEL CATALOGO
	   ============================================================ */

	toggleFiltersBtn.onclick = () => {
		filtersArea.classList.toggle("collapsed");
		toggleFiltersBtn.textContent =
			filtersArea.classList.contains("collapsed") ? "‚¨áÔ∏è" : "‚¨ÜÔ∏è";
	};

	function attachDayDeleteHandlers() {
		document.querySelectorAll(".delete-day-btn").forEach(btn => {
			btn.onclick = () => {
				const day = parseInt(btn.dataset.day);
				const box = document.querySelector(`.day-box:nth-child(${day})`);

				if (!box) return;

				if (!confirm(`Vuoi davvero eliminare il Giorno ${day}?`)) return;

				// Rimuovi tutti gli item di questo giorno da insertedTitles
				const items = box.querySelectorAll(".day-item input");
				items.forEach(inp => {
					const title = inp.value;

					// Verifica se esiste in altri giorni
					let stillPresent = false;

					document.querySelectorAll(".day-item input").forEach(other => {
						if (other !== inp && other.value === title) {
							stillPresent = true;
						}
					});

					if (!stillPresent) {
						insertedTitles.delete(title);
					}
				});

				// Aggiorna il catalogo
				render();



				box.remove();

				renumberDays();
			};
		});
	}

function renumberDays() {
    const boxes = document.querySelectorAll(".day-box");

    boxes.forEach((box, index) => {
        const newDay = index + 1;

        // aggiorna ID drop-area
        const drop = box.querySelector(".drop-area");
        drop.id = `day-${newDay}`;

        // aggiorna input titolo
        const titleInput = box.querySelector(".day-title-input");

        // se il titolo ha struttura base, riscrivi numero
        if (titleInput.value.startsWith("Giorno ")) {
            titleInput.value = titleInput.value.replace(/Giorno \d+/, `Giorno ${newDay}`);
        }

        // aggiorna icone
        box.querySelector(".day-icons").id = `day-icons-${newDay}`;

        // aggiorna bottone elimina
        const btn = box.querySelector(".delete-day-btn");
        btn.dataset.day = newDay;
    });

    // ristabilisce gli handler
    attachDayDeleteHandlers();
}

document.addEventListener("click", function(e) {

    // Se clicco su un pulsante immagini
    if (e.target.classList.contains("img-btn")) {

        const dayItem = e.target.closest(".day-item");
        const gallery = dayItem.querySelector(".img-gallery");

        // Crea input file ‚Äúnascosto‚Äù
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.multiple = true;
        input.style.display = "none";

        input.onchange = (ev) => {
            const files = Array.from(ev.target.files);

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = () => {
                    const img = document.createElement("img");
                    img.src = reader.result;
                    img.className = "detail-img";
                    gallery.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        };

        // Attiva finestra upload
        input.click();
    }
});

function handleImageUpload(e, imgContainer) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
        const src = ev.target.result;

        // CREA IL WRAPPER (contenitore immagine + X)
        let wrapper = document.createElement("div");
        wrapper.className = "img-wrapper";
        wrapper.style.display = "inline-block";
        wrapper.style.position = "relative";
        wrapper.style.marginRight = "6px";

        wrapper.innerHTML = `
            <img src="${src}" class="detail-img"
                 style="width:70px; height:70px; object-fit:cover; border-radius:6px;">
            <div class="delete-img"
                 style="
                    position:absolute;
                    top:-6px; right:-6px;
                    background:#e74c3c; color:white;
                    width:20px; height:20px;
                    line-height:20px; text-align:center;
                    border-radius:50%; cursor:pointer;
                 ">
                 ‚úï
            </div>
        `;

        // RIMOZIONE IMMAGINE
        wrapper.querySelector(".delete-img").onclick = () => {
            wrapper.remove();
        };

        imgContainer.appendChild(wrapper);
    };

    reader.readAsDataURL(file);
}

function exportItinerary() {

    let days = [];

    const dayBoxes = document.querySelectorAll(".day-box");

    dayBoxes.forEach((box, index) => {

        const dayNumber = index + 1;

        const title =
            box.querySelector(".day-title-input")?.value ||
            `Giorno ${dayNumber}`;

        const items = [];

        box.querySelectorAll(".day-item").forEach(el => {

            items.push({
                title: el.querySelector("input")?.value || "",
                desc: el.querySelector("textarea")?.value || "",
                start: el.querySelector(".start-time")?.value || "",
                end:   el.querySelector(".end-time")?.value || "",
                duration: el.querySelector(".duration")?.value || "",
                images: Array.from(el.querySelectorAll(".img-thumb")).map(i => i.src)
            });

        });

        days.push({
            day: dayNumber,
            title,
            items
        });
    });

    return { days };
}

document.getElementById("saveBtn").onclick = () => {

    const title = prompt("Inserisci un titolo per il preventivo:");

    if (!title || title.trim() === "") {
        alert("Titolo non valido.");
        return;
    }

    const itineraries = getSavedItineraries();

    // Esporta l‚Äôitinerario
    const json = exportItinerary();

    // Salva
    itineraries[title] = json;

    saveItineraries(itineraries);

    alert("Preventivo salvato come: " + title);
};


function loadItineraryFromJSON(json) {

    itinerary.innerHTML = "";

    json.days.forEach(day => {

        const box = document.createElement("div");
        box.className = "day-box";

        box.innerHTML = `
            <div class='day-title'>
                <input class="day-title-input" value="${day.title}">
                <span class="day-icons" id="day-icons-${day.day}"></span>

                <button class="delete-day-btn" data-day="${day.day}"
                        style="float:right; background:#e74c3c; color:white; border:none; padding:4px 8px; border-radius:4px;">
                    üóë
                </button>
            </div>

            <div class='drop-area' id='day-${day.day}'></div>
        `;

        itinerary.appendChild(box);

        const drop = box.querySelector(".drop-area");

        // Attiva drag&drop
        Sortable.create(drop, {
            animation: 150,
            group: "itinerary",
            forceFallback: true,
            fallbackOnBody: true,
            fallbackTolerance: 3,
            onSort: () => updateDayIcons(day.day)
        });

        // Ricrea i dettagli del giorno
        day.items.forEach(item => {
            const el = document.createElement("div");
            el.className = "day-item";

            el.innerHTML = `
                <input class="item-title" value="${item.title}">
                <textarea class="item-desc" rows="2">${item.desc}</textarea>

                <div class="time-row">
                    <input type="time" class="start-time" value="${item.start}">
                    <input type="time" class="end-time" value="${item.end}">
                    <input type="number" class="duration" placeholder="Durata" value="${item.duration}">
                </div>

                <div class="images-area">
                    ${item.images.map(src => `<img src="${src}" class="img-thumb">`).join("")}
                </div>

                <button class="remove-btn">‚úï</button>
            `;

            el.querySelector(".remove-btn").onclick = () => {
                el.remove();
                updateDayIcons(day.day);
            };

            drop.appendChild(el);
        });

        updateDayIcons(day.day);
    });

    attachDayDeleteHandlers();
}

document.getElementById("loadBtn").onclick = () => {

    const saved = localStorage.getItem("savedItinerary");

    if (!saved) {
        alert("Nessun itinerario salvato.");
        return;
    }

    const json = JSON.parse(saved);
    loadItineraryFromJSON(json);

    alert("Itinerario caricato!");
};

function getSavedItineraries() {
    return JSON.parse(localStorage.getItem("savedItineraries") || "{}");
}

function saveItineraries(obj) {
    localStorage.setItem("savedItineraries", JSON.stringify(obj));
}


document.getElementById("loadBtn").onclick = () => {
    openLoadModal();
};

function openLoadModal() {
    
    const list = document.getElementById("loadList");
    const modal = document.getElementById("loadModal");

    const itineraries = getSavedItineraries();

    list.innerHTML = "";

    const titles = Object.keys(itineraries);

    if (titles.length === 0) {
        list.innerHTML = "<p>Nessun preventivo salvato.</p>";
    }

    titles.forEach(t => {

        const row = document.createElement("div");
        row.style = "display:flex; justify-content:space-between; margin-bottom:8px; padding:6px; background:#f5f5f5; border-radius:6px;";

        row.innerHTML = `
            <div>${t}</div>
            <div>
                <button onclick='loadThis("${t}")'
                    style="background:#3498db; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">
                    Carica
                </button>

                <button onclick='deleteThis("${t}")'
                    style="background:#e74c3c; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; margin-left:5px;">
                    Elimina
                </button>
            </div>
        `;

        list.appendChild(row);
    });

    modal.style.display = "flex";
}

function closeLoadModal() {
    document.getElementById("loadModal").style.display = "none";
}

function loadThis(name) {

    const itineraries = getSavedItineraries();

    if (!itineraries[name]) {
        alert("Preventivo non trovato.");
        return;
    }

    loadItineraryFromJSON(itineraries[name]);

    alert("Preventivo caricato: " + name);

    closeLoadModal();
}

function deleteThis(name) {

    if (!confirm("Vuoi davvero eliminare il preventivo: " + name + "?")) return;

    const itineraries = getSavedItineraries();

    delete itineraries[name];

    saveItineraries(itineraries);

    openLoadModal(); // Refresh lista
}


	</script>

<div id="loadModal" 
     style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6);
            justify-content:center; align-items:center; z-index:99999;">
    
    <div style="background:white; width:400px; padding:20px; border-radius:10px;">

        <h3>Carica un preventivo salvato</h3>

        <div id="loadList" style="margin-top:15px; max-height:300px; overflow-y:auto;"></div>

        <button onclick="closeLoadModal()"
            style="margin-top:15px; padding:8px 14px; border:none; background:#aaa; border-radius:6px; color:white;">
            Chiudi
        </button>
    </div>
</div>

	</body>
	</html>
